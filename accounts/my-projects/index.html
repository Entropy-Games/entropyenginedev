<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>
        My Projects
    </title>

    <meta name="viewport" content="width=device-width">
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <link rel='stylesheet' href="../../global.css">
    <script>
        $(() => {
            $("#header").load("../../header.html");
        });
    </script>
</head>
<body>
<div id="header"></div>

<a href="../create-project" style="margin: 10px">New Project</a>

<p style="font-size: 20px; margin-left: 40px">
    My Projects
</p>

<div id="my-projects"></div>
<p style="font-size: 20px; margin-left: 40px; margin-top: 50px">
    Shared With Me
</p>

<div id="shared-projects"></div>
</body>
</html>

<style>

    #my-projects, #shared-projects {
        margin-top: 10px;
    }

    .project-button {
        text-decoration: none;
        background-color: var(--input-bg);
        margin: 4px;
        padding: 8px;
        font-size: 14px;
        text-align: center;
        height: 30px;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
    }

    .project-button:hover {
        background-color: vaR(--input-hover-bg);
    }

    .projectName {
        float: left;
        background: none;
        max-width: 33%;
        font-size: 28px;
        overflow: hidden;
        margin-top: 1px;
        display: flex;
        align-items: center;
    }
</style>

<script type="module">
    import {request} from '../../request.js';

    let myProjects = $('#my-projects');
    let sharedWithMe = $('#shared-projects');

    request('/get-project-names', {
        userID: localStorage.id
    }).then(async projectNames => {

    	const myUsername = (await request('/get-username', {
    		userID: localStorage.id
    	})).username;

        for (let projectName of projectNames) {
        	const isShared = projectName.level != 3;

            (!isShared ? myProjects : sharedWithMe).append(`

            <div
                class="project-button"
                onclick="window.location.href = '../../editor?p=${projectName._id}'"
            >
            <div class="projectName">
                <img
                    src="../../projects/${projectName._id}/build/assets/COVER.png"
                    alt="COVER"
                    style="
                        width: 40px;
                        height:40px;
                        border-radius: 4px;
                        margin-right: 4px;
                        font-size: 10px;
                    "
                />
                ${projectName.name}
                </div>


                <div id="other-people-${projectName._id}"></div>

            ${isShared ? '' :`

                <div style="background: none">
                    <a href="../delete-project?p=${projectName._id}" style="background: none">
                        delete
                    </a>
                </div>
            `}
             </div>

            `);

            const editors = await request(`/get-project-editors`, {
                projectID: projectName._id
            });

            const editorsHTML = () => {
            	// these are just my projects, always have 'me' first
            	let html = ['me'];

            	let i = 0;
            	for (const editor of editors) {
            		if (i > 5) {
            			html.push(`and ${editors.length-5} others`);
						return html.join(', ');
                    }

            		if (editor.username === myUsername)
						continue;

                    html.push(editor.username);
            		i++;
                }

            	return html.join(', ');
            };

            $(`#other-people-${projectName._id}`).html(`(${editorsHTML()})`);
        }
		if (!myProjects.html()) {
			myProjects.html(`<div style="text-align: center">Looks like you haven't made any projects yet!</div>`);
		}

		if (!sharedWithMe.html()) {
			sharedWithMe.html(`<div style="text-align: center">Looks like no-one has shared any projects with you yet!</div>`);
		}
    });
</script>